FROM ghcr.io/cgwalters/fedora-silverblue:38

# Install ZFS repository
RUN rpm-ostree install https://zfsonlinux.org/fedora/zfs-release-2-3$(rpm --eval "%{dist}").noarch.rpm && \
    # cleanup and verification stage
    rm -vrf /var /*.rpm && \
    ostree container commit

# Install dkms deps
RUN rpm-ostree install \
    kernel-devel kernel-devel-matched kernel-headers kernel-srpm-macros && \
    # cleanup and verification stage
    rm -vrf /var && \
    ostree container commit

# TODO: Remove the following line once these bugs are fixed:
# - https://github.com/coreos/rpm-ostree/issues/4201
# - https://github.com/coreos/rpm-ostree/issues/1614
RUN test -f /usr/bin/ld || ln -s /usr/bin/ld.bfd /usr/bin/ld

# Install zfs and tell dkms to install the module
RUN rpm-ostree install zfs zfs-dracut && \
    dkms autoinstall -k $(rpm -qa kernel --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}') && \
    # cleanup and verification stage
    rm -vrf /var && \
    ostree container commit

# Add samsung usb udev rules so that dracut picks them up (makes trim work)
ADD files/dracut/10-samsung-usb.rules /usr/lib/dracut/modules.d/10samsung/
ADD files/dracut/module-setup.sh /usr/lib/dracut/modules.d/10samsung/

# Fix selinux so that it allows zfs to mount snapshots
ADD files/selinux/twiest-zfs.pp /usr/share/selinux/packages/
ADD files/selinux/twiest-zfs.pp.bz2 /usr/share/selinux/packages/
ADD files/selinux/twiest-zfs-selinux.service /etc/systemd/system/
RUN systemctl enable twiest-zfs-selinux

# Install dracut requirements
RUN rpm-ostree install busybox rng-tools dmraid nvme-cli biosdevname device-mapper-multipath && \
    # cleanup and verification stage
    rm -vrf /var && \
    ostree container commit

# Setup zfs for inclusion in dracut
RUN echo 'add_dracutmodules+=" zfs "' > /etc/dracut.conf.d/zfs.conf && \
    echo 'force_drivers+=" zfs "' >> /etc/dracut.conf.d/zfs.conf

## Setup dracut / put zfs module in initrd
RUN export KERNEL_VERSION="$(rpm -qa kernel --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}')" && \
    mkdir -p /var/tmp/dracut /var/roothome && \
    dracut --reproducible -v --add 'ostree' --tmpdir '/var/tmp/dracut' -f --no-hostonly --kver "${KERNEL_VERSION}" && \
    mv -v "/lib/modules/${KERNEL_VERSION}/initramfs.img" "/lib/modules/${KERNEL_VERSION}/initramfs.orig.img" && \
    mv -v /boot/initramfs*.img "/lib/modules/${KERNEL_VERSION}/initramfs.img" && \
    # cleanup and verification stage
    rm -vrf /var && \
    ostree container commit


# TODO: Remove the following line once these bugs are fixed:
# - https://github.com/coreos/rpm-ostree/issues/4201
# - https://github.com/coreos/rpm-ostree/issues/1614
RUN test -h /usr/bin/ld && rm -v /usr/bin/ld
